<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Sanremo 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}

body{
  margin:0;
  min-height:100svh;
  font-family:Arial, sans-serif;
  color:white;
  background:url("sfondo.png") no-repeat center 25%;
  background-size:cover;
  display:flex;
  justify-content:center;
  align-items:center;
}

.hidden{display:none}

/* ===== CONTENITORE SCHERMO ===== */
#screen{
  width:100%;
  min-height:100svh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  padding:12px;
}

/* ===== LOGHI ===== */
#logos{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  margin-bottom:14px;
}
#logos img{
  max-width:480px;
  width:90%;
  height:auto;
}

/* ===== BOX ===== */
.box{
  width:100%;
  max-width:420px;
  background:rgba(0,0,0,.45);
  padding:18px;
  border-radius:14px;
}

input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{
  background:gold;
  color:black;
  font-weight:bold;
  cursor:pointer;
}

/* ===== DESKTOP ===== */
@media(min-width:900px){
  .box{max-width:600px}
  #logos img{max-width:520px}
}

/* ===== VOTO ===== */
.artist{margin:8px 0}

/* ===== CLASSIFICA ===== */
.bar{
  background:linear-gradient(90deg,gold,orange);
  height:28px;
  border-radius:10px;
  margin:8px 0;
  padding-left:10px;
  line-height:28px;
  color:black;
  font-weight:bold;
  width:0;
  transition:width 1s;
}

/* ===== PODIO ===== */
#podium{
  display:flex;
  justify-content:center;
  gap:20px;
  margin:30px 0;
  flex-wrap:wrap;
}
.podium-box{
  background:gold;
  color:black;
  padding:20px;
  border-radius:16px;
  text-align:center;
  width:30%;
  min-width:160px;
  font-weight:bold;
  font-size:18px;
}

/* ===== REGIA ===== */
.regia #screen{
  justify-content:flex-start;
}
.regia input,
.regia h2,
.regia #login{
  display:none!important;
}
</style>
</head>

<body>

<div id="screen">

  <div id="logos">
    <img src="logo-sanremo-2026.png" alt="Sanremo 2026">
    <img src="logo-cinema.png" alt="Cinema">
  </div>

  <div class="box" id="login">
    <input id="nickname" placeholder="Nickname">
    <input id="code" placeholder="Codice">
    <button id="btnStart">Entra</button>
  </div>

  <div class="box hidden" id="vote">
    <h2>Vota tutti i cantanti (1â€“10)</h2>
    <div id="artists"></div>
    <button id="btnSubmit">Invia voti</button>
  </div>

  <div class="box hidden" id="presenter">
    <button id="btnShow">MOSTRA CLASSIFICA</button>
    <button id="btnReveal">RIVELA PODIO</button>
    <button id="btnReset">RESET</button>
    <div id="ranking"></div>
    <div id="podium" class="hidden"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== FIREBASE ===== */
const firebaseConfig={
  apiKey:"AIzaSyCwqBPd1zFT5SM6e2oUqD09UIF8kOcNisE",
  authDomain:"sanremo-2026.firebaseapp.com",
  projectId:"sanremo-2026",
  storageBucket:"sanremo-2026.appspot.com",
  messagingSenderId:"585160817288",
  appId:"1:585160817288:web:71c4552fc2cfd73c9dfd3d"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* ===== CONFIG ===== */
const PRESENTER_CODE="SANREMO26";
const artists=[
"Arisa","Bambole di Pezza","Chiello","Dargen D'Amico","Ditonellapiaga",
"Eddie Brock","Elettra Lamborghini","Enrico Nigiotti","Ermal Meta","Fedez & Masini",
"Francesco Renga","Fulminacci","J-Ax","LDA & Aka7even","Leo Gassmann",
"Levante","LuchÃ¨","Malika Ayane","Mara Sattei","Maria Antonietta",
"Michele Bravi","Nayt","Patty Pravo","Raf","Sal Da Vinci",
"Samurai Jay","Sayf","Serena Brancale","Tommaso Paradiso","Tredici Pietro"
];

let votes=Array(artists.length).fill(5);
let top3=[];

/* ===== ELEMENTI ===== */
const login=document.getElementById("login");
const voteBox=document.getElementById("vote");
const presenter=document.getElementById("presenter");
const artistsDiv=document.getElementById("artists");
const ranking=document.getElementById("ranking");
const podium=document.getElementById("podium");

/* ===== LOGIN ===== */
btnStart.onclick=()=>{
  if(!nickname.value||!code.value)return alert("Compila tutto");
  login.classList.add("hidden");
  if(code.value===PRESENTER_CODE){
    presenter.classList.remove("hidden");
  }else{
    voteBox.classList.remove("hidden");
    renderArtists();
  }
};

/* ===== VOTO ===== */
function renderArtists(){
  artistsDiv.innerHTML="";
  artists.forEach((a,i)=>{
    const d=document.createElement("div");
    d.className="artist";
    d.innerHTML=`${a}<input type="range" min="1" max="10" value="1"><span> 1</span>`;
    const r=d.querySelector("input");
    const s=d.querySelector("span");
    r.oninput=()=>{s.textContent=" "+r.value;votes[i]=+r.value};
    artistsDiv.appendChild(d);
  });
}

btnSubmit.onclick=async()=>{
  await addDoc(collection(db,"votes"),{votes});
  alert("Voto inviato!");
  voteBox.classList.add("hidden");
};

/* ===== CALCOLO ===== */
async function calcola(){
  const snap=await getDocs(collection(db,"votes"));
  let res=artists.map((a,i)=>{
    let s=0,c=0;
    snap.forEach(d=>{if(d.data().votes?.[i]!=null){s+=d.data().votes[i];c++}});
    return {name:a,avg:c?s/c:0};
  }).sort((a,b)=>a.avg-b.avg);
  top3=res.slice(-3).reverse();
  return res.slice(0,-3);
}

/* ===== CLASSIFICA PROGRESSIVA ===== */
btnShow.onclick=async()=>{
  ranking.innerHTML="";
  const others=await calcola();
  let i=0;
  function reveal(){
    if(i>=others.length)return;
    const t=others[i];
    const bar=document.createElement("div");
    bar.className="bar";
    bar.textContent=`${others.length-i+3}. ${t.name} â€“ ${t.avg.toFixed(2)}`;
    ranking.appendChild(bar);
    requestAnimationFrame(()=>bar.style.width=(t.avg*10)+"%");
    i++;
    setTimeout(reveal,500);
  }
  reveal();
};

/* ===== PODIO ===== */
btnReveal.onclick=async()=>{
  document.documentElement.requestFullscreen?.();
  document.body.classList.add("regia");
  await calcola();
  podium.innerHTML="";
  podium.classList.remove("hidden");
  const order=[2,1,0];
  let i=0;
  function show(){
    if(i>=3)return;
    const t=top3[order[i]];
    const d=document.createElement("div");
    d.className="podium-box";
    d.innerHTML=`${["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][order[i]]}<br>${t.name}<br>${t.avg.toFixed(2)}`;
    podium.appendChild(d);
    gold();
    i++;
    setTimeout(show,2000);
  }
  show();
};

/* ===== ORO ===== */
function gold(){
  for(let i=0;i<40;i++){
    const p=document.createElement("div");
    p.style=`position:fixed;width:8px;height:8px;background:gold;border-radius:50%;top:-10px;left:${Math.random()*100}vw`;
    document.body.appendChild(p);
    p.animate([{transform:"translateY(0)"},{transform:"translateY(100vh)",opacity:0}],{duration:2000});
    setTimeout(()=>p.remove(),2200);
  }
}

/* ===== RESET ===== */
btnReset.onclick=async()=>{
  if(!confirm("Reset totale?"))return;
  const snap=await getDocs(collection(db,"votes"));
  for(const d of snap.docs)await deleteDoc(doc(db,"votes",d.id));
  ranking.innerHTML="";
  podium.innerHTML="";
  alert("Reset fatto");
};
</script>
</body>
</html>
