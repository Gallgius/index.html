<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Sanremo 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  font-family:Arial;
  color:white;
  padding:20px;
  min-height:100vh;
  background: url("sfondo.png") no-repeat center 25%;
  background-size: cover;
}
.box{max-width:800px;margin:auto;background:rgba(255,255,255,.05);padding:20px;border-radius:12px}
.hidden{display:none}
input,button{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:none;font-size:16px;box-sizing:border-box}
button{background:gold;color:black;font-weight:bold;cursor:pointer}
.artist{margin:10px 0}
.bar{background:linear-gradient(90deg,gold,orange);height:26px;border-radius:8px;margin:6px 0;line-height:26px;padding-left:10px;color:black;font-weight:bold;transition:width 1s}
#podium{display:flex;gap:20px;justify-content:center;margin:20px 0;flex-wrap:wrap}
.podium-box{width:30%;background:gold;color:black;padding:15px;border-radius:12px;text-align:center;font-weight:bold}
.logo-normal{max-width:250px;width:80%;margin:20px auto;display:block}
.logo-presenter{max-width:500px;width:90%;margin:40px auto;display:block;box-shadow:0 0 25px gold}
 #logo{
  position: relative;
  z-index: 10;
}
 
</style>
</head>
<body>

<h1>ðŸŽ¤ Sanremo 2026</h1>
<img id="logo" src="Logo_Festival_di_Sanremo_2026.svg.png" class="logo-normal" alt="Sanremo">

<div class="box" id="login">
  <input id="nickname" placeholder="Nickname">
  <input id="code" placeholder="Codice">
  <button id="btnStart">Entra</button>
</div>

<div class="box hidden" id="vote">
  <h2>Vota tutti (1â€“10)</h2>
  <div id="artists"></div>
  <button id="btnSubmit">Invia voti</button>
</div>

<div class="box hidden" id="presenter">
  <button id="btnShow">MOSTRA CLASSIFICA</button>
  <button id="btnReveal">RIVELA PODIO</button>
  <button id="btnReset">RESET VOTI</button>
  <div id="podium" class="hidden"></div>
  <div id="ranking"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCwqBPd1zFT5SM6e2oUqD09UIF8kOcNisE",
  authDomain: "sanremo-2026.firebaseapp.com",
  projectId: "sanremo-2026",
  storageBucket: "sanremo-2026.appspot.com",
  messagingSenderId: "585160817288",
  appId: "1:585160817288:web:71c4552fc2cfd73c9dfd3d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const PRESENTER_CODE="SANREMO26";
const artists=["Arisa","Bambole di Pezza","Chiello","Dargen","Ditonellapiaga","Eddie Brock",
"Elettra","Nigiotti","Ermal","Fedez & Masini","Renga","Fulminacci","J-Ax","LDA","Leo","Levante",
"LuchÃ¨","Malika","Mara","Maria A.","Michele","Nayt","Patty","Raf","Sal","Samurai","Sayf",
"Serena","Paradiso","Tredici"];

let votes=Array(artists.length).fill(5);
let hasVoted=false;
let top3=[];

const nicknameEl=document.getElementById("nickname");
const codeEl=document.getElementById("code");
const login=document.getElementById("login");
const voteBox=document.getElementById("vote");
const presenter=document.getElementById("presenter");
const artistsDiv=document.getElementById("artists");
const ranking=document.getElementById("ranking");
const podium=document.getElementById("podium");
const btnStart=document.getElementById("btnStart");
const btnSubmit=document.getElementById("btnSubmit");
const btnShow=document.getElementById("btnShow");
const btnReveal=document.getElementById("btnReveal");
const btnReset=document.getElementById("btnReset");

/* LOGIN */
btnStart.onclick=()=>{
  if(!nicknameEl.value||!codeEl.value) return alert("Compila tutto");
  login.classList.add("hidden");
  const logo=document.getElementById("logo");
  if(codeEl.value===PRESENTER_CODE){
    presenter.classList.remove("hidden");
    logo.className="logo-presenter";
    document.body.classList.remove("no-bg");
  }
 else{
  if(hasVoted) alert("Hai giÃ  votato!");
  else{
    voteBox.classList.remove("hidden");
    renderArtists();
    logo.className="logo-normal";
    // NON togliamo piÃ¹ lo sfondo
  }
}

};

/* VOTI */
function renderArtists(){
  artistsDiv.innerHTML="";
  artists.forEach((a,i)=>{
    const d=document.createElement("div");
    d.className="artist";
    d.innerHTML=`${a}<input type="range" min="1" max="10" value="5"><span> 5</span>`;
    const r=d.querySelector("input");
    const s=d.querySelector("span");
    r.oninput=()=>{s.textContent=" "+r.value;votes[i]=+r.value;}
    artistsDiv.appendChild(d);
  });
}

btnSubmit.onclick=async()=>{
  if(hasVoted){alert("Hai giÃ  votato!");return;}
  await addDoc(collection(db,"votes"),{votes});
  hasVoted=true;
  btnSubmit.disabled=true;
  btnSubmit.textContent="Voto giÃ  inviato";
  alert("Voto inviato!");
  voteBox.classList.add("hidden");
};

/* CLASSIFICA */
async function calcolaClassifica(){
  const snap=await getDocs(collection(db,"votes"));
  let totals=artists.map((a,i)=>{
    let sum=0,count=0;
    snap.forEach(d=>{
      const v=d.data().votes?.[i];
      if(v!==undefined){sum+=v;count++;}
    });
    return {name:a,avg:count?sum/count:0};
  }).sort((a,b)=>a.avg-b.avg);
  top3=totals.slice(-3).reverse();
  return totals.slice(0,-3);
}

btnShow.onclick=async()=>{
  ranking.innerHTML="";
  const others=await calcolaClassifica();
  let i=0;
  const timer=setInterval(()=>{
    if(i>=others.length){clearInterval(timer);return;}
    const t=others[i];
    const pos=(others.length-i)+3;
    const bar=document.createElement("div");
    bar.className="bar";
    bar.style.width="5%";
    bar.textContent=`${pos}. ${t.name} â€“ 0.00`;
    ranking.appendChild(bar);
    setTimeout(()=>{
      bar.style.width=(t.avg*10)+"%";
      bar.textContent=`${pos}. ${t.name} â€“ ${t.avg.toFixed(2)}`;
    },100);
    i++;
  },2000);
};

/* BEEP */
function playBeep(){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  osc.type="sine"; osc.frequency.value=800; gain.gain.value=0.2;
  osc.connect(gain); gain.connect(ctx.destination);
  osc.start();
  setTimeout(()=>{osc.stop();ctx.close();},150);
}

/* PODIO CON CONTO ALLA ROVESCIA */
btnReveal.onclick=async()=>{
  await calcolaClassifica();
  podium.innerHTML="";
  podium.classList.remove("hidden");

  let count=10;
  const counter=document.createElement("div");
  counter.style.fontSize="80px";
  counter.style.fontWeight="bold";
  counter.style.textAlign="center";
  counter.style.margin="30px 0";
  podium.appendChild(counter);

  const timer=setInterval(()=>{
    if(count>0){
      counter.textContent=count;
      playBeep();
      count--;
    }else{
      clearInterval(timer);
      podium.innerHTML="";
      top3.forEach((t,i)=>{
        const d=document.createElement("div");
        d.className="podium-box";
        d.innerHTML=`
          <div style="font-size:60px">${["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][i]}</div>
          <div>${t.name}</div>
          <div>${t.avg.toFixed(2)}</div>
        `;
        podium.appendChild(d);
      });
    }
  },1000);
};

btnReset.onclick=async()=>{
  if(!confirm("Cancellare tutti i voti?")) return;
  const snap=await getDocs(collection(db,"votes"));
  for(const d of snap.docs){await deleteDoc(doc(db,"votes",d.id));}
  ranking.innerHTML=""; podium.innerHTML="";
  hasVoted=false; btnSubmit.disabled=false; btnSubmit.textContent="Invia voti";
  alert("Voti cancellati!");
};
</script>
</body>
</html>
